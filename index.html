<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wim Hof Breathing Simulator</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body {
    padding: 2rem;
    max-width: 600px;
    margin: auto;
  }
  #phaseDisplay {
    font-size: 1.3rem;
    font-weight: 600;
    margin-top: 1rem;
  }
  #timerDisplay {
    font-size: 2.2rem;
    font-weight: bold;
    margin-top: 0.2rem;
    color: #007bff;
    display: none; /* Hidden initially */
  }
  #settingsToggle {
    cursor: pointer;
    font-size: 1.5rem;
    position: fixed;
    top: 1rem;
    right: 1rem;
    user-select: none;
  }
</style>
</head>
<body>
  <h2 class="mb-4 text-center">Wim Hof Breathing Simulator</h2>

  <div id="settingsToggle" title="Show Settings">&#9881;</div> <!-- Gear icon -->

  <form id="settingsForm" autocomplete="off" style="display:none;">
    <div class="mb-3">
      <label for="prepTime" class="form-label">Preparation Time (seconds)</label>
      <input type="number" class="form-control" id="prepTime" min="0" value="10" />
    </div>
    <div class="mb-3">
      <label for="rounds" class="form-label">Number of Rounds</label>
      <input type="number" class="form-control" id="rounds" min="1" value="3" />
      <div class="form-text">You can assign custom timers to up to (Rounds - 1) rounds.</div>
    </div>
    <div class="mb-3">
      <label for="breathSpeed" class="form-label">Breath Speed (seconds per inhale/exhale)</label>
      <input type="number" class="form-control" id="breathSpeed" min="1" value="3" />
    </div>
    <div class="mb-3">
      <label for="numBreaths" class="form-label">Number of Breaths per Round</label>
      <input type="number" class="form-control" id="numBreaths" min="1" value="30" />
    </div>
    <div class="mb-3">
      <label for="breathOutHold" class="form-label">Hold Time (seconds)</label>
      <input type="number" class="form-control" id="breathOutHold" min="0" value="90" />
    </div>
    <div class="mb-3">
      <label for="deepBreathTime" class="form-label">Deep Breath Inhale Time (seconds)</label>
      <input type="number" class="form-control" id="deepBreathTime" min="1" value="4" />
    </div>
    <div class="mb-3">
      <label for="holdTime" class="form-label">Hold Time After Deep Breath (seconds)</label>
      <input type="number" class="form-control" id="holdTime" min="0" value="15" />
    </div>
    <div class="mb-3">
      <label for="pauseAfterRound" class="form-label">Pause After Each Round (seconds)</label>
      <input type="number" class="form-control" id="pauseAfterRound" min="0" value="7" />
    </div>

    <hr />

    <div class="mb-4">
      <h5>Custom Rounds</h5>
      <div class="row g-2 align-items-center mb-2">
        <div class="col-auto">
          <input
            type="number"
            class="form-control"
            id="customRoundNumberInput"
            min="1"
            placeholder="Round #"
            title="Round number between 1 and total rounds"
          />
        </div>
        <div class="col-auto">
          <input
            type="number"
            class="form-control"
            id="customRoundTimeInput"
            min="1"
            placeholder="Hold Time (seconds)"
            title="Custom hold time in seconds"
          />
        </div>
        <div class="col-auto">
          <button type="button" id="addCustomRoundBtn" class="btn btn-secondary">Add Custom Round</button>
        </div>
      </div>
      <ul id="customRoundsList" class="list-group"></ul>
      <div class="form-text">You can add custom hold times to up to <span id="maxCustomRoundsText"></span> rounds.</div>
    </div>
  </form>

  <!-- Simple controls always visible -->
  <div id="simpleControls" class="d-flex justify-content-center gap-3 mb-3">
    <button type="button" id="startBtnSimple" class="btn btn-primary">Start</button>
    <button type="button" id="stopBtnSimple" class="btn btn-danger" disabled>Stop</button>
  </div>

  <div id="phaseDisplay" class="text-center mt-4"></div>
  <div id="timerDisplay" class="text-center"></div>

  <footer class="text-center text-sm text-gray-500 mt-6 mb-4">
    Made with ❤️ in EU · <a href="https://github.com/avra911/wim-hof-breathing-simulator" target="_blank" class="underline hover:text-blue-500">GitHub Repo</a>
  </footer>  

<script>
  // Helper sleep function
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  // Beep using Web Audio API
  function playBeep(freq, duration) {
    try {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();

      oscillator.frequency.value = freq;
      oscillator.type = 'sine';

      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      oscillator.start();

      gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration / 1000);

      oscillator.stop(audioCtx.currentTime + duration / 1000);

      setTimeout(() => audioCtx.close(), duration + 50);
    } catch {
      // AudioContext might be blocked or unavailable
    }
  }

  // Elements
  const inputs = [
    'prepTime', 'rounds', 'breathSpeed', 'numBreaths',
    'breathOutHold', 'holdTime', 'deepBreathTime', 'pauseAfterRound'
  ].map(id => document.getElementById(id));

  const customRoundNumberInput = document.getElementById('customRoundNumberInput');
  const customRoundTimeInput = document.getElementById('customRoundTimeInput');
  const addCustomRoundBtn = document.getElementById('addCustomRoundBtn');
  const customRoundsList = document.getElementById('customRoundsList');
  const maxCustomRoundsText = document.getElementById('maxCustomRoundsText');

  // Simple controls buttons
  const startBtnSimple = document.getElementById('startBtnSimple');
  const stopBtnSimple = document.getElementById('stopBtnSimple');

  const settingsForm = document.getElementById('settingsForm');
  const settingsToggle = document.getElementById('settingsToggle');
  const simpleControls = document.getElementById('simpleControls');

  const phaseDisplay = document.getElementById('phaseDisplay');
  const timerDisplay = document.getElementById('timerDisplay');

  let stopRequested = false;
  let running = false;

  // Frequencies for sounds
  const inhaleFreq = 440;
  const exhaleFreq = 330;
  const holdFreq = 220;
  const roundEndFreq = 550;
  const prepBeepFreq = 660;

  // Store custom rounds in Map: roundNumber -> holdTime
  let customRounds = new Map();

  // Update max custom rounds text
  function updateMaxCustomRoundsText() {
    const rounds = parseInt(document.getElementById('rounds').value, 10) || 1;
    maxCustomRoundsText.textContent = (rounds - 1) > 0 ? (rounds - 1) : 0;
  }

  // Render custom rounds list
  function renderCustomRounds() {
    customRoundsList.innerHTML = '';
    if (customRounds.size === 0) {
      customRoundsList.innerHTML = '<li class="list-group-item text-muted">No custom rounds added</li>';
      return;
    }
    [...customRounds.entries()]
      .sort((a,b) => a[0] - b[0])
      .forEach(([round, time]) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = `Round ${round}: Hold Time = ${time} sec`;
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-danger';
        btn.textContent = 'Remove';
        btn.onclick = () => {
          customRounds.delete(round);
          renderCustomRounds();
        };
        li.appendChild(btn);
        customRoundsList.appendChild(li);
      });
  }

  // Add custom round handler
  addCustomRoundBtn.addEventListener('click', () => {
    const round = parseInt(customRoundNumberInput.value, 10);
    const time = parseInt(customRoundTimeInput.value, 10);
    const maxRounds = parseInt(document.getElementById('rounds').value, 10) || 1;

    if (!round || round < 1 || round > maxRounds) {
      alert(`Round number must be between 1 and ${maxRounds}`);
      return;
    }
    if (!time || time < 1) {
      alert('Hold time must be a positive number');
      return;
    }
    if (customRounds.has(round)) {
      alert(`Custom hold time for Round ${round} is already set. Remove it first to add a new one.`);
      return;
    }
    // Max custom rounds allowed: rounds - 1
    if (customRounds.size >= maxRounds - 1) {
      alert(`You can only set custom hold times for up to ${maxRounds - 1} rounds.`);
      return;
    }

    customRounds.set(round, time);
    renderCustomRounds();

    customRoundNumberInput.value = '';
    customRoundTimeInput.value = '';
  });

  // Update max custom rounds text on rounds input change
  document.getElementById('rounds').addEventListener('input', () => {
    updateMaxCustomRoundsText();
  });

  // Settings toggle button
  let settingsVisible = false;
  settingsToggle.addEventListener('click', () => {
    settingsVisible = !settingsVisible;
    if (settingsVisible) {
      settingsForm.style.display = 'block';
      settingsToggle.innerHTML = '&#10006;'; // X icon
      simpleControls.style.display = 'none'; // Hide simple controls when settings shown
    } else {
      settingsForm.style.display = 'none';
      settingsToggle.innerHTML = '&#9881;'; // Gear icon
      simpleControls.style.display = 'flex';
    }
  });

  // Initialize max custom rounds text
  updateMaxCustomRoundsText();

  // Initialize with round 1 custom hold time = 60
  customRounds.set(1, 60);
  renderCustomRounds();

  // Timer display helper
  function displayTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return m > 0 ? `${m}:${s.toString().padStart(2,'0')}` : s.toString();
  }

  // Show timer display
  function showTimer() {
    timerDisplay.style.display = 'block';
  }

  // Hide timer display
  function hideTimer() {
    timerDisplay.style.display = 'none';
  }

  // Main async breathing loop
  async function runBreathing() {
    stopRequested = false;
    running = true;

    const prepTime = parseInt(document.getElementById('prepTime').value, 10) || 10;
    const totalRounds = parseInt(document.getElementById('rounds').value, 10) || 3;
    const breathSpeed = parseInt(document.getElementById('breathSpeed').value, 10) || 3;
    const numBreaths = parseInt(document.getElementById('numBreaths').value, 10) || 30;
    const breathOutHold = parseInt(document.getElementById('breathOutHold').value, 10) || 90;
    const holdTime = parseInt(document.getElementById('holdTime').value, 10) || 15;
    const deepBreathTime = parseInt(document.getElementById('deepBreathTime').value, 10) || 4;
    const pauseAfterRound = parseInt(document.getElementById('pauseAfterRound').value, 10) || 7;

    startBtnSimple.disabled = true;
    stopBtnSimple.disabled = false;

    // Preparation Phase
    phaseDisplay.textContent = "Get Ready...";
    showTimer();
    timerDisplay.textContent = displayTime(prepTime);
    for (let i = prepTime; i > 0; i--) {
      if (stopRequested) break;
      timerDisplay.textContent = displayTime(i);
      playBeep(prepBeepFreq, 150);
      await sleep(1000);
    }
    hideTimer();

    if (stopRequested) {
      resetUI();
      return;
    }

    for (let round = 1; round <= totalRounds; round++) {
      if (stopRequested) break;

      // Breathing phase: numBreaths cycles inhale/exhale
      phaseDisplay.textContent = `Round ${round} - Breathing`;

      for (let breath = 1; breath <= numBreaths; breath++) {
        hideTimer();
        if (stopRequested) break;

        // Inhale
        phaseDisplay.textContent = `Round ${round} - Breath ${breath} Inhale`;
        timerDisplay.textContent = displayTime(breathSpeed);
        playBeep(inhaleFreq, 200);
        await sleep(breathSpeed * 1000);
        if (stopRequested) break;

        // Exhale
        phaseDisplay.textContent = `Round ${round} - Breath ${breath} Exhale`;
        timerDisplay.textContent = displayTime(breathSpeed);
        playBeep(exhaleFreq, 200);
        await sleep(breathSpeed * 1000);
      }
      if (stopRequested) break;

      // Hold after breath out
      let holdAfterBreathOut = customRounds.has(round) ? customRounds.get(round) : breathOutHold;
      phaseDisplay.textContent = `Round ${round} - Hold after breath out`;
      showTimer();
      for (let i = holdAfterBreathOut; i > 0; i--) {
        if (stopRequested) break;
        timerDisplay.textContent = displayTime(i);
        playBeep(holdFreq, 150);
        await sleep(1000);
      }
      hideTimer();
      if (stopRequested) break;

      // Deep breath in
      phaseDisplay.textContent = `Round ${round} - Deep Breath Inhale`;
      timerDisplay.textContent = displayTime(deepBreathTime);
      playBeep(inhaleFreq, 200);
      await sleep(deepBreathTime * 1000);

      if (stopRequested) break;

      // Hold after deep breath
      phaseDisplay.textContent = `Round ${round} - Hold after Deep Breath`;
      showTimer();
      for (let i = holdTime; i > 0; i--) {
        if (stopRequested) break;
        timerDisplay.textContent = displayTime(i);
        playBeep(holdFreq, 150);
        await sleep(1000);
      }
      hideTimer();
      if (stopRequested) break;

      // Pause after round except after last
      if (round !== totalRounds) {
        phaseDisplay.textContent = `Round ${round} - Breath out`;
        showTimer();
        for (let i = pauseAfterRound; i > 0; i--) {
          if (stopRequested) break;
          timerDisplay.textContent = displayTime(i);
          await sleep(1000);
        }
        hideTimer();
      }

      playBeep(roundEndFreq, 300);
    }

    phaseDisplay.textContent = 'Finished!';
    hideTimer();
    timerDisplay.textContent = '';

    resetUI();
  }

  // Reset UI to initial state
  function resetUI() {
    running = false;
    stopRequested = false;
    startBtnSimple.disabled = false;
    stopBtnSimple.disabled = true;
    hideTimer();
    timerDisplay.textContent = '';
  }

  startBtnSimple.addEventListener('click', () => {
    if (!running) {
      runBreathing();
    }
  });

  stopBtnSimple.addEventListener('click', () => {
    if (running) {
      stopRequested = true;
      phaseDisplay.textContent = 'Stopping...';
    }
  });

  // Initialize UI
  resetUI();
</script>
</body>
</html>
